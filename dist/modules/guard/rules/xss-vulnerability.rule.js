// src/modules/guard/rules/xss-vulnerability.rule.ts
// ═══════════════════════════════════════════════════════════════
//                      XSS VULNERABILITY RULE
// ═══════════════════════════════════════════════════════════════
/**
 * Detects potential Cross-Site Scripting (XSS) vulnerabilities.
 * OWASP Top 10 - A7:2017 / A03:2021 (Injection)
 */
export class XssVulnerabilityRule {
    name = 'xss-vulnerability';
    enabled = true;
    description = 'Detects potential Cross-Site Scripting (XSS) vulnerabilities';
    category = 'security';
    // Dangerous patterns that may lead to XSS
    dangerousPatterns = [
        // innerHTML with variable
        {
            pattern: /\.innerHTML\s*=\s*(?!['"`])[^;]+/,
            message: 'Unsafe innerHTML assignment with variable',
            severity: 'block',
        },
        // outerHTML with variable
        {
            pattern: /\.outerHTML\s*=\s*(?!['"`])[^;]+/,
            message: 'Unsafe outerHTML assignment with variable',
            severity: 'block',
        },
        // document.write with variable
        {
            pattern: /document\.write\s*\(\s*(?!['"`])[^)]+\)/,
            message: 'Unsafe document.write with variable',
            severity: 'block',
        },
        // document.writeln with variable
        {
            pattern: /document\.writeln\s*\(\s*(?!['"`])[^)]+\)/,
            message: 'Unsafe document.writeln with variable',
            severity: 'block',
        },
        // eval with variable
        {
            pattern: /\beval\s*\(\s*(?!['"`])[^)]+\)/,
            message: 'Dangerous eval() with variable input',
            severity: 'block',
        },
        // setTimeout/setInterval with string
        {
            pattern: /set(?:Timeout|Interval)\s*\(\s*(?!function|=>)[^,)]+,/,
            message: 'setTimeout/setInterval with string (potential code injection)',
            severity: 'error',
        },
        // new Function with variable
        {
            pattern: /new\s+Function\s*\([^)]*\+[^)]+\)/,
            message: 'new Function() with concatenated string',
            severity: 'block',
        },
        // jQuery html() with variable
        {
            pattern: /\.\$?\(.*\)\.html\s*\(\s*(?!['"`])[^)]+\)/,
            message: 'jQuery .html() with variable (use .text() instead)',
            severity: 'error',
        },
        // React dangerouslySetInnerHTML
        {
            pattern: /dangerouslySetInnerHTML\s*=\s*\{\s*\{\s*__html\s*:\s*(?!['"`])/,
            message: 'React dangerouslySetInnerHTML with variable',
            severity: 'error',
        },
        // v-html in Vue with variable
        {
            pattern: /v-html\s*=\s*["'][^"']*\+|v-html\s*=\s*["']\s*[^"']+[^"']\s*["']/,
            message: 'Vue v-html directive with dynamic content',
            severity: 'error',
        },
        // Angular [innerHTML] binding
        {
            pattern: /\[innerHTML\]\s*=\s*["'][^"']+["']/,
            message: 'Angular innerHTML binding (ensure sanitization)',
            severity: 'error',
        },
        // PHP echo without htmlspecialchars
        {
            pattern: /<\?(?:php)?\s*echo\s+\$(?!_(?:GET|POST|REQUEST|COOKIE|SERVER|ENV|FILES))/,
            message: 'PHP echo variable without htmlspecialchars()',
            severity: 'error',
        },
        // PHP direct output of user input
        {
            pattern: /<\?(?:php)?.*echo.*\$_(?:GET|POST|REQUEST|COOKIE)\[/,
            message: 'Direct output of user input in PHP',
            severity: 'block',
        },
        // Template literal in innerHTML
        {
            pattern: /\.innerHTML\s*=\s*`[^`]*\$\{[^}]+\}[^`]*`/,
            message: 'Template literal in innerHTML with interpolation',
            severity: 'block',
        },
        // URL parameter directly used
        {
            pattern: /(?:location\.search|URLSearchParams)[^;]*\.innerHTML/,
            message: 'URL parameter used in innerHTML',
            severity: 'block',
        },
        // Event handler from variable
        {
            pattern: /\.on\w+\s*=\s*(?!function|=>|\(\))[^;]+/,
            message: 'Event handler assigned from variable',
            severity: 'error',
        },
        // insertAdjacentHTML with variable
        {
            pattern: /\.insertAdjacentHTML\s*\(\s*['"][^'"]+['"]\s*,\s*(?!['"`])[^)]+\)/,
            message: 'insertAdjacentHTML with variable',
            severity: 'block',
        },
    ];
    // Safe patterns that indicate proper sanitization
    safePatterns = [
        /DOMPurify\.sanitize/i,
        /escape(?:Html|String|Xml)/i,
        /htmlspecialchars/i,
        /htmlentities/i,
        /sanitize(?:Html)?/i,
        /textContent\s*=/,
        /innerText\s*=/,
        /createTextNode/,
        /encodeURIComponent/,
        /\.text\(\)/, // jQuery .text()
        /xss-safe/i, // Comment marker
    ];
    validate(code, filename) {
        const issues = [];
        const lines = code.split('\n');
        // Skip non-web files
        if (this.shouldSkipFile(filename)) {
            return issues;
        }
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const context = this.getContext(lines, i);
            // Skip if line has safe patterns
            if (this.isSafePattern(line) || this.isSafePattern(context)) {
                continue;
            }
            // Skip comments
            if (this.isComment(line)) {
                continue;
            }
            // Check for dangerous patterns
            for (const { pattern, message, severity } of this.dangerousPatterns) {
                if (pattern.test(line)) {
                    issues.push({
                        rule: this.name,
                        severity,
                        message: `XSS Risk: ${message}`,
                        location: {
                            file: filename,
                            line: i + 1,
                            snippet: line.trim().slice(0, 100),
                        },
                        suggestion: this.getSuggestion(message),
                        autoFixable: false,
                    });
                    break; // One issue per line
                }
            }
        }
        return issues;
    }
    // ═══════════════════════════════════════════════════════════════
    //                      PRIVATE METHODS
    // ═══════════════════════════════════════════════════════════════
    shouldSkipFile(filename) {
        // Skip non-web related files
        const skipExtensions = ['.sql', '.sh', '.bash', '.ps1', '.py', '.go', '.rs', '.java'];
        return skipExtensions.some(ext => filename.endsWith(ext));
    }
    getContext(lines, index) {
        const start = Math.max(0, index - 2);
        const end = Math.min(lines.length, index + 3);
        return lines.slice(start, end).join('\n');
    }
    isSafePattern(text) {
        return this.safePatterns.some(pattern => pattern.test(text));
    }
    isComment(line) {
        const trimmed = line.trim();
        return trimmed.startsWith('//') ||
            trimmed.startsWith('*') ||
            trimmed.startsWith('/*') ||
            trimmed.startsWith('#') ||
            trimmed.startsWith('<!--');
    }
    getSuggestion(message) {
        if (message.includes('innerHTML')) {
            return 'Use textContent or DOMPurify.sanitize() instead of innerHTML';
        }
        if (message.includes('document.write')) {
            return 'Avoid document.write(); use DOM manipulation methods instead';
        }
        if (message.includes('eval')) {
            return 'Never use eval() with user input; use JSON.parse() for JSON data';
        }
        if (message.includes('setTimeout') || message.includes('setInterval')) {
            return 'Use function reference instead of string: setTimeout(fn, time)';
        }
        if (message.includes('jQuery') || message.includes('.html()')) {
            return 'Use .text() for plain text or sanitize input before .html()';
        }
        if (message.includes('dangerouslySetInnerHTML')) {
            return 'Sanitize content with DOMPurify before using dangerouslySetInnerHTML';
        }
        if (message.includes('PHP')) {
            return 'Use htmlspecialchars($var, ENT_QUOTES, "UTF-8") for output';
        }
        return 'Sanitize user input before inserting into DOM';
    }
}
//# sourceMappingURL=xss-vulnerability.rule.js.map